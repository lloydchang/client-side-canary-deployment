<!-- index.html - Client-Side Canary Deployment with Session-Based Assignment -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client-Side Canary Deployment</title>
  <script src="js/canary-config.js"></script>
  <script>
    // Configuration
    const configUrl = 'config.json';
    const stableVersion = 'stable';
    const canaryVersion = 'canary';

    // Check sessionStorage for version assignment, if not assigned, assign one based on configuration
    function getVersionFromSession() {
      const version = sessionStorage.getItem('version');
      if (version) return version;
      
      // Use CanaryConfig for more intelligent decision making
      if (window.CanaryConfig && window.CanaryConfig.shouldUseCanary) {
        return window.CanaryConfig.shouldUseCanary() ? canaryVersion : stableVersion;
      }
      
      // Fallback to random assignment if config is not available
      return Math.random() < 0.5 ? canaryVersion : stableVersion;
    }

    function setVersionInSession(version) {
      sessionStorage.setItem('version', version);
      // Track version assignment timing for performance analysis
      sessionStorage.setItem('version_assigned_at', Date.now().toString());
    }

    // Try to fetch the actual configuration from server
    async function fetchConfig() {
      try {
        const response = await fetch(configUrl);
        if (response.ok) {
          const config = await response.json();
          return config;
        }
      } catch (e) {
        console.error('Error fetching configuration:', e);
      }
      return null;
    }

    async function init() {
      // Try to load server-side config (optional)
      const serverConfig = await fetchConfig();
      
      // Merge server config with client config if available
      if (serverConfig && window.CanaryConfig) {
        if (serverConfig.stableVersion) window.CanaryConfig.stableVersion = serverConfig.stableVersion;
        if (serverConfig.canaryVersion) window.CanaryConfig.canaryVersion = serverConfig.canaryVersion;
        if (serverConfig.distribution && serverConfig.distribution.canaryPercentage !== undefined) {
          window.CanaryConfig.distribution.canaryPercentage = serverConfig.distribution.canaryPercentage;
        }
      }
      
      // Get and set version in session
      const version = getVersionFromSession();
      setVersionInSession(version);
      
      // Store metadata about assignment
      if (window.CanaryConfig) {
        sessionStorage.setItem('canary_assignment_data', JSON.stringify({
          timestamp: Date.now(),
          currentPercentage: window.CanaryConfig.getCurrentCanaryPercentage(),
          gradualRollout: window.CanaryConfig.distribution.gradualRollout,
          daysSinceDeployment: Math.floor(
            (new Date().getTime() - new Date(window.CanaryConfig.distribution.initialDate).getTime()) 
            / (1000 * 60 * 60 * 24)
          )
        }));
      }
      
      // Redirect to appropriate version
      window.location.replace(`${version}/index.html`);
    }

    window.onload = init;
  </script>
</head>
<body>
  <h1>Redirecting...</h1>
  <p>You're being directed to the appropriate version of the application.</p>
  <noscript>
    <p>JavaScript is required for this application. Please enable JavaScript and reload the page.</p>
    <p>You can manually access the <a href="stable/index.html">stable version</a>.</p>
  </noscript>
</body>
</html>
