name: Canary Deployment & Analytics

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run (deploy, analyze, or adjust-canary)'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - analyze
          - adjust-canary
      canary_percentage:
        description: 'New canary percentage (only for adjust-canary task)'
        required: false
        type: number
  schedule:
    - cron: '*/5 * * * *' # Run every 5 minutes
  #   - cron: '0 */6 * * *' # Run every 6 hours

permissions:
  contents: write
  pages: write
  id-token: write

# Define reusable values
env:
  NODE_VERSION: '22'
  GIT_USER_NAME: 'lloydchang'
  GIT_USER_EMAIL: 'lloydchang@gmail.com'

jobs:
  # Deployment job
  build-and-deploy:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'deploy')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3
      
      - name: Setup Node.js ⚙️
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Update Version ⬆️
        run: |
          ./.github/scripts/update-version.sh
          cat frontend/version.json
      
      - name: Replace PostHog Keys
        run: |
          mkdir -p frontend/assets/config
          
          # Use the template from .github/config to create the runtime config
          cp .github/config/canary-config-template.json frontend/assets/config/canary-config.json
          
          # Update with secrets
          cat > frontend/assets/config/canary-config.json << EOF
          {
            "posthog": {
              "apiKey": "${{ secrets.POSTHOG_PUBLIC_KEY }}",
              "projectId": "${{ secrets.POSTHOG_PROJECT_ID }}",
              "host": "https://us.i.posthog.com"
            },
            "canary": {
              "initialPercentage": 5,
              "maxPercentage": 50,
              "incrementStep": 5
            }
          }
          EOF
      
      - name: Configure Base Path
        run: |
          touch .nojekyll
          mkdir -p config
          echo '{ "baseUrl": "/client-side-canary-deployment" }' > config/gh-pages.json
      
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: frontend  # Deploy the frontend directory
          branch: gh-pages
          clean: true
          single-commit: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit Updated Version 💾
        run: |
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          git add frontend/version.json
          git commit -m "Update version to $(jq -r .version frontend/version.json)" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Analytics job with consolidated script
  analyze-canary:
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'analyze')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Run unified canary analysis and update
        id: canary_analysis
        env:
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }}
          POSTHOG_PUBLIC_KEY: ${{ secrets.POSTHOG_PUBLIC_KEY }}
          POSTHOG_HOST: 'https://us.i.posthog.com'
          ERROR_THRESHOLD: ${{ vars.ERROR_THRESHOLD || '0.02' }}
          TIMEFRAME: ${{ vars.TIMEFRAME || '24h' }}
          INCREMENT_STEP: ${{ vars.INCREMENT_STEP || '5' }}
          MAX_PERCENTAGE: ${{ vars.MAX_PERCENTAGE || '50' }}
          SAFETY_THRESHOLD: ${{ vars.SAFETY_THRESHOLD || '2' }}
          USE_MOCK_DATA: 'false'
        run: |
          chmod +x ./.github/scripts/canary-analyzer.js
          node ./.github/scripts/canary-analyzer.js
          
          # Extract values for later steps
          CANARY_PERCENTAGE=$(jq -r '.recommendation.percentage' canary-analysis.json)
          REASON=$(jq -r '.recommendation.reason' canary-analysis.json)
          MESSAGE=$(jq -r '.recommendation.message' canary-analysis.json)
          RECOMMENDED_ACTION=$(jq -r '.analytics.analysis.recommendedAction' canary-analysis.json)
          
          echo "CANARY_PERCENTAGE=$CANARY_PERCENTAGE" >> $GITHUB_ENV
          echo "CANARY_UPDATE_REASON=$REASON" >> $GITHUB_ENV
          echo "CANARY_UPDATE_MESSAGE=$MESSAGE" >> $GITHUB_ENV
          echo "RECOMMENDED_ACTION=$RECOMMENDED_ACTION" >> $GITHUB_ENV
          
          if [[ "$RECOMMENDED_ACTION" == "rollback" ]]; then
            echo "::warning::$MESSAGE"
          else
            echo "::notice::$MESSAGE"
          fi
      
      - name: Create summary report
        run: |
          echo "# Canary Deployment Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Analysis timestamp: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Version | Pageviews | Errors | Error Rate |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|--------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Stable | $(jq -r '.analytics.stable.pageviews' canary-analysis.json) | $(jq -r '.analytics.stable.errors' canary-analysis.json) | $(jq -r '.analytics.stable.errorRate' canary-analysis.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Canary | $(jq -r '.analytics.canary.pageviews' canary-analysis.json) | $(jq -r '.analytics.canary.errors' canary-analysis.json) | $(jq -r '.analytics.canary.errorRate' canary-analysis.json) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Relative error increase: $(jq -r '.analytics.analysis.relativeErrorIncrease' canary-analysis.json)" >> $GITHUB_STEP_SUMMARY
          echo "- Exceeds threshold: $(jq -r '.analytics.analysis.exceedsThreshold' canary-analysis.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Recommended action**: $(jq -r '.analytics.analysis.recommendedAction' canary-analysis.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Canary Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **$CANARY_UPDATE_MESSAGE**" >> $GITHUB_STEP_SUMMARY
      
      - name: Save Analytics Results
        uses: actions/upload-artifact@v4
        with:
          name: analytics-results
          path: canary-analysis.json
          retention-days: 30
      
      # Combined step for updating repos and deploying to both branches
      - name: Update repositories and deploy
        run: |
          # 1. Update version.json to trigger client refresh
          ./.github/scripts/update-version.sh
          
          # 2. Configure git with credentials
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          
          # 3. Fetch latest changes first to avoid conflicts
          git fetch origin
          
          # 4. Get the latest commit from main to avoid conflicts
          git reset --hard origin/main
          
          # 5. Apply our changes on top of the latest code
          ./.github/scripts/update-version.sh  # Re-run after reset to ensure we have a fresh version
          
          # 6. Generate new configuration files if they don't exist after reset
          if [ ! -f "frontend/assets/config/canary-config.js" ] || [ ! -f "frontend/assets/config/canary-config.json" ]; then
            echo "Regenerating configuration files after reset..." does not exist"
            chmod +x ./.github/scripts/canary-analyzer.js
            node ./.github/scripts/canary-analyzer.js
          fi6. Generate new configuration files if they don't exist after reset
          echo "Generating configuration files with canary percentage: $CANARY_PERCENTAGE%"
          # 7. Stage all changesipts/canary-analyzer.js
          git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
          
          # 8. Check if there are changes to commit/updated
          if ! git diff --staged --quiet; thenalyzer script:"
            git commit -m "Update canary percentage to $CANARY_PERCENTAGE% based on analytics""
            t frontend/assets/config/canary-config.json || echo "canary-config.json does not exist"
            # 9. Push with improved conflict handling
            echo "Pushing changes to main branch..."nually updating if necessary
            MAX_RETRIES=3tend/assets/config/canary-config.js" ] || [ ! -f "frontend/assets/config/canary-config.json" ]; then
            RETRY_COUNT=0g missing configuration files manually..."
            mkdir -p frontend/assets/config/
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Pull latest changes with rebase to minimize conflicts
              git pull --rebase origin main
              iguration
              # If rebase encounters conflicts, abort and try a different approach
              if [ $? -ne 0 ]; then
                echo "Rebase failed due to conflicts, trying alternative approach..."
                git rebase --abort
                # Reset to origin/main and apply our changes as a new commit
                git reset --hard origin/main
                ./.github/scripts/update-version.sh  # Re-run version update
                chmod +x ./.github/scripts/canary-analyzer.js
                node ./.github/scripts/canary-analyzer.js  # Re-run analysis
                git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
                git commit -m "Update canary percentage to $CANARY_PERCENTAGE% based on analytics (conflict resolution)"
              fie globally
              onfig = CanaryConfig;
              # Try to push
              if git push origin main; thenebugging
                echo "Successfully pushed changes to main branch"g.distribution);" > frontend/assets/config/canary-config.js
                break
              elsete JSON config
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, retrying in 5 seconds... (Attempt $RETRY_COUNT of $MAX_RETRIES)"
                  sleep 5${CANARY_PERCENTAGE}',
                else: true,
                  echo "::warning::Failed to push changes after $MAX_RETRIES attempts. Continuing with gh-pages update only."
                  break2
                fi
              fi
            done: 1,
          elsealse,
            echo "No changes to commit in main branch"}}'",
          fiProjectId": "'${{ secrets.POSTHOG_PROJECT_ID }}'"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}'",
      ateSource": "automated"
      # Combined deployment steps for gh-pages
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:. Stage all changes
          branch: gh-pages/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}d
          folder: frontend  # Deploy from frontend directory
          target-folder: frontend  # Deploy to frontend directory on gh-pages branch
          
  # Adjust canary job - manualare changes to commit
  adjust-canary:it diff --staged --quiet; then
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'adjust-canary'
    runs-on: ubuntu-latest
    steps:  # 10. Push with improved conflict handling
      - name: Checkout and setups to main branch..."
        uses: actions/checkout@v3
            RETRY_COUNT=0
      - name: Setup Node.js
        uses: actions/setup-node@v3t $MAX_RETRIES ]; do
        with: # Pull latest changes with rebase to minimize conflicts
          node-version: ${{ env.NODE_VERSION }}
              
      - name: Run manual canary updateonflicts, abort and try a different approach
        env:  if [ $? -ne 0 ]; then
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}ing alternative approach..."
          POSTHOG_PUBLIC_KEY: ${{ secrets.POSTHOG_PUBLIC_KEY }}
          POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }} a new commit
          USE_MOCK_DATA: 'false' origin/main
        run: |  ./.github/scripts/update-version.sh  # Re-run version update
          chmod +x ./.github/scripts/canary-analyzer.jszer.js
          node ./.github/scripts/canary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}
                git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
      # Combined step for updating repos and deploying to both branchesENTAGE% based on analytics (conflict resolution)"
      - name: Update repositories and deploy
        run: |
          # 1. Update version.json to trigger client refresh
          ./.github/scripts/update-version.sh
                echo "Successfully pushed changes to main branch"
          # 2. Configure git with credentials
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
          # 3. Fetch latest changes first to avoid conflicts. (Attempt $RETRY_COUNT of $MAX_RETRIES)"
          git fetch origin
                else
          # 4. Get the latest commit from main to avoid conflictsMAX_RETRIES attempts. Continuing with gh-pages update only."
          git reset --hard origin/main
                fi
          # 5. Apply our changes on top of the latest code
          ./.github/scripts/update-version.sh  # Re-run after reset to ensure we have a fresh version
          else
          # 6. Re-run the canary analyzer with our percentage
          chmod +x ./.github/scripts/canary-analyzer.js
          node ./.github/scripts/canary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}
          mkdir -p frontend/assets/config/GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 7. Stage all changes
          git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
          echo "Generating configuration files with canary percentage: ${{ github.event.inputs.canary_percentage }}%"me: Deploy to gh-pages
          # 8. Check if there are changes to commitr.jsv4
          if ! git diff --staged --quiet; thener.js --percentage=${{ github.event.inputs.canary_percentage }}
            git commit -m "Manual update of canary percentage to ${{ github.event.inputs.canary_percentage }}%"
            Debug: Verify config files were created/updatedean: false
            # 9. Push with improved conflict handlingscript:"
            echo "Pushing changes to main branch..."s || echo "canary-config.js does not exist"irectory
            MAX_RETRIES=3sets/config/canary-config.json || echo "canary-config.json does not exist"frontend  # Deploy to frontend directory on gh-pages branch
            RETRY_COUNT=0
            7. Ensure we have the config files by manually updating if necessaryanary job - manual
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; doig.js" ] || [ ! -f "frontend/assets/config/canary-config.json" ]; then
              # Pull latest changes with rebase to minimize conflicts.task == 'adjust-canary'
              git pull --rebase origin main/
              
              # If rebase encounters conflicts, abort and try a different approach
              if [ $? -ne 0 ]; then
                echo "Rebase failed due to conflicts, trying alternative approach..."
                git rebase --abortons
                # Reset to origin/main and apply our changes as a new commit
                git reset --hard origin/main
                ./.github/scripts/update-version.sh  # Re-run version update
                chmod +x ./.github/scripts/canary-analyzer.js
                node ./.github/scripts/canary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}  # Re-run with manual percentage
                git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
                git commit -m "Manual update of canary percentage to ${{ github.event.inputs.canary_percentage }}% (conflict resolution)"
              fi $(date +%s)G_PUBLIC_KEY: ${{ secrets.POSTHOG_PUBLIC_KEY }}
              ID: ${{ secrets.POSTHOG_PROJECT_ID }}
              # Try to push
              if git push origin main; then
                echo "Successfully pushed changes to main branch"
                breakalyzer.js --percentage=${{ github.event.inputs.canary_percentage }}
              else is loaded to help with debugging
                RETRY_COUNT=$((RETRY_COUNT + 1))on:', CanaryConfig.distribution);" > frontend/assets/config/canary-config.jsloying to both branches
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, retrying in 5 seconds... (Attempt $RETRY_COUNT of $MAX_RETRIES)"
                  sleep 5son to trigger client refresh
                else1.0.0",scripts/update-version.sh
                  echo "::warning::Failed to push changes after $MAX_RETRIES attempts. Continuing with gh-pages update only."
                  break '${{ github.event.inputs.canary_percentage }}',e git with credentials
                fit": true,ig --local user.name "${{ env.GIT_USER_NAME }}"
              fiod": 7,nfig --local user.email "${{ env.GIT_USER_EMAIL }}"
            donehold": 2
          elseest changes first to avoid conflicts
            echo "No changes to commit in main branch"
          fiate": 1,
        env: false,4. Get the latest commit from main to avoid conflicts
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}EY }}'",
      osthogProjectId": "'${{ secrets.POSTHOG_PROJECT_ID }}'"    
      # Combined deployment steps for gh-pages
      - name: Deploy to gh-pagesY-%m-%dT%H:%M:%SZ")'",te-version.sh  # Re-run after reset to ensure we have a fresh version
        uses: JamesIves/github-pages-deploy-action@v4
        with:/assets/config/canary-config.json. Re-run the canary analyzer with our percentage
          branch: gh-pagesary-analyzer.js
          clean: falseanary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}
          token: ${{ secrets.GITHUB_TOKEN }}
          folder: frontend  # Deploy from frontend directoryig/canary-config.json frontend/assets/config/canary-config.js
          target-folder: frontend  # Deploy to frontend directory on gh-pages branch
          # Debug: Show what files are staged    
      - name: Create summary reportmmit:"hanges to commit
        run: |diff --staged --name-status git diff --staged --quiet; then
          echo "# Canary Percentage Adjustment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY to commit
          echo "✅ Successfully updated canary percentage to ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARYof canary percentage to ${{ github.event.inputs.canary_percentage }}%" branch..."
          
          # Show files that were changed in this update
          echo "## Files Updated" >> $GITHUB_STEP_SUMMARY            echo "Pushing changes to main branch..."            


















          echo "The version.json file has also been updated to trigger client refreshes." >> $GITHUB_STEP_SUMMARY          echo "Changes have been committed to both main and gh-pages branches." >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY                    fi            echo "❌ assets/config/canary-config.json was not created/updated" >> $GITHUB_STEP_SUMMARY          else            echo "- assets/config/canary-config.json" >> $GITHUB_STEP_SUMMARY          if [ -f "frontend/assets/config/canary-config.json" ]; then                    fi            echo "❌ assets/config/canary-config.js was not created/updated" >> $GITHUB_STEP_SUMMARY          else            echo "- assets/config/canary-config.js" >> $GITHUB_STEP_SUMMARY          if [ -f "frontend/assets/config/canary-config.js" ]; then                    echo "- version.json" >> $GITHUB_STEP_SUMMARY



























































          echo "The version.json file has also been updated to trigger client refreshes." >> $GITHUB_STEP_SUMMARY          echo "Changes have been committed to both main and gh-pages branches." >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY          echo "✅ Successfully updated canary percentage to ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY          echo "" >> $GITHUB_STEP_SUMMARY          echo "# Canary Percentage Adjustment" >> $GITHUB_STEP_SUMMARY        run: |      - name: Create summary report                target-folder: frontend  # Deploy to frontend directory on gh-pages branch          folder: frontend  # Deploy from frontend directory          token: ${{ secrets.GITHUB_TOKEN }}          clean: false          branch: gh-pages        with:        uses: JamesIves/github-pages-deploy-action@v4      - name: Deploy to gh-pages      # Combined deployment steps for gh-pages                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}        env:          fi            echo "No changes to commit in main branch"          else            done              fi                fi                  break                  echo "::warning::Failed to push changes after $MAX_RETRIES attempts. Continuing with gh-pages update only."                else                  sleep 5                  echo "Push failed, retrying in 5 seconds... (Attempt $RETRY_COUNT of $MAX_RETRIES)"                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then                RETRY_COUNT=$((RETRY_COUNT + 1))              else                break                echo "Successfully pushed changes to main branch"              if git push origin main; then              # Try to push                            fi                git commit -m "Manual update of canary percentage to ${{ github.event.inputs.canary_percentage }}% (conflict resolution)"                git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js                node ./.github/scripts/canary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}  # Re-run with manual percentage                chmod +x ./.github/scripts/canary-analyzer.js                ./.github/scripts/update-version.sh  # Re-run version update                git reset --hard origin/main                # Reset to origin/main and apply our changes as a new commit                git rebase --abort                echo "Rebase failed due to conflicts, trying alternative approach..."              if [ $? -ne 0 ]; then              # If rebase encounters conflicts, abort and try a different approach                            git pull --rebase origin main              # Pull latest changes with rebase to minimize conflicts            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do                        RETRY_COUNT=0            MAX_RETRIES=3            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Pull latest changes with rebase to minimize conflicts
              git pull --rebase origin main
              
              # If rebase encounters conflicts, abort and try a different approach
              if [ $? -ne 0 ]; then
                echo "Rebase failed due to conflicts, trying alternative approach..."
                git rebase --abort
                # Reset to origin/main and apply our changes as a new commit
                git reset --hard origin/main
                ./.github/scripts/update-version.sh  # Re-run version update
                chmod +x ./.github/scripts/canary-analyzer.js
                node ./.github/scripts/canary-analyzer.js --percentage=${{ github.event.inputs.canary_percentage }}  # Re-run with manual percentage
                git add frontend/version.json frontend/assets/config/canary-config.json frontend/assets/config/canary-config.js
                git commit -m "Manual update of canary percentage to ${{ github.event.inputs.canary_percentage }}% (conflict resolution)"
              fi
              
              # Try to push
              if git push origin main; then
                echo "Successfully pushed changes to main branch"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Push failed, retrying in 5 seconds... (Attempt $RETRY_COUNT of $MAX_RETRIES)"
                  sleep 5
                else
                  echo "::warning::Failed to push changes after $MAX_RETRIES attempts. Continuing with gh-pages update only."
                  break
                fi
              fi
            done
          else
            echo "No changes to commit in main branch"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Combined deployment steps for gh-pages
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          clean: false
          token: ${{ secrets.GITHUB_TOKEN }}
          folder: frontend  # Deploy from frontend directory
          target-folder: frontend  # Deploy to frontend directory on gh-pages branch
      
      - name: Create summary report
        run: |
          echo "# Canary Percentage Adjustment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully updated canary percentage to ${{ github.event.inputs.canary_percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes have been committed to both main and gh-pages branches." >> $GITHUB_STEP_SUMMARY
          echo "The version.json file has also been updated to trigger client refreshes." >> $GITHUB_STEP_SUMMARY
